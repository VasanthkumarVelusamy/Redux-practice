<!DOCTYPE html>
<html>
    <head>
        <title>TODOs/Goals</title>
    </head>
    <body>
        <div>
            <h1>Todos</h1>
            <input id="todo" placeholder="add todo" type ='text'>
            <button id="addTodoButton"> Add Todo</button>
            <ul id="todos"></ul>
        </div>
        <div>
            <h1>Goals</h1>
            <input id="goal" placeholder="add goal" type ='text'>
            <button id="addGoalButton"> Add Todo</button>
            <ul id="goals"></ul>
        </div>
        <script type="text/javascript">
            function generateId() {
                return Date.now().toString(36) + Math.random().toString(36).substr(2);
            }

            function createStore(reducer) {
                // Store should have the following components
                // 1. the state.
                // 2. getting the state.
                // 3. listening to the changes of the state
                // 4. updating the state

                let state
                let listeners = []

                let getState = () => state

                let subscribe = (listener) => {
                    listeners.push(listener)

                    return () => {
                        listeners = listeners.filter((l) => l !== listener)
                    }
                }

                let dispatch = (action) => {
                    // 1. call reducer function to update the state
                    state = reducer(state, action)
                    // 2. loop over the listeners and invoke them
                    listeners.forEach(listener => listener())
                }

                return {
                    getState,
                    subscribe,
                    dispatch
                }
            }

            // App code

            const ADD_TODO = 'ADD_TODO'
            const REMOVE_TODO = 'REMOVE_TODO'
            const TOGGLE_TODO = 'TOGGLE_TODO'
            const ADD_GOAL = 'ADD_GOAL'
            const REMOVE_GOAL = 'REMOVE_GOAL'

            // Action creators
            const addTodoAction = (todo) => {
                return {
                    type: ADD_TODO,
                    todo
                }
            }

            const removeTodoAction = (id) => {
                return {
                    type: REMOVE_TODO,
                    id
                }
            }

            const toggleTodoAction = (id) => {
                return {
                    type: TOGGLE_TODO,
                    id
                }
            }

            const addGoalAction = (goal) => {
                return {
                    type: ADD_GOAL,
                    goal
                }
            }

            const removeGoalAction = (id) => {
                return {
                    type: REMOVE_GOAL,
                    id
                }
            }

            const todos = (state = [], action) => {
                switch (action.type) {
                    case ADD_TODO:
                        return [...state, action.todo]
                    case REMOVE_TODO:
                        return state.filter((todo) => todo.id !== action.id)
                    case TOGGLE_TODO:
                        return state.map((todo) => todo.id !== action.id ? todo : {...todo, complete: !todo.complete})
                    default:
                        return state
                }
            }

            const goals = (state = [], action) => {
                switch (action.type) {
                    case ADD_GOAL:
                        return [...state, action.goal]
                    case REMOVE_GOAL:
                        return state.filter((goal) => goal.id !== action.id)
                    default:
                        return state
                }
            }

            const app = (state = {}, action) => {
                return {
                    todos: todos(state.todos, action),
                    goals: goals(state.goals, action)
                }
            }



            const myStore = createStore(app)

            const unsubscribe = myStore.subscribe(()=> { // adding this callback to the listeners array in the store. So it will be called when state change occurs.
                const { todos, goals } = myStore.getState()
                console.log('todos ', todos)
                console.log('goals ', goals)

                document.getElementById('goals').innerHTML = ""
                document.getElementById('todos').innerHTML = ""

                todos.forEach(addTodoToDOM)
                goals.forEach(addGoalToDOM)
            })

            // DOM code
            function createRemoveButton(onClick) {
                const button = document.createElement('button')
                button.innerText = "X"
                button.addEventListener('click', onClick)
                return button
            }

            function addTodoToDOM(todo) {
                const listItem = document.createElement('li')
                const text = document.createTextNode(todo.name)
                listItem.appendChild(text)
                listItem.appendChild(createRemoveButton(()=>{
                    myStore.dispatch(removeTodoAction(todo.id))
                }))
                listItem.style.textDecoration = todo.complete ? 'line-through' : 'none'
                listItem.addEventListener('click', ()=>myStore.dispatch(toggleTodoAction(todo.id)))
                const todosList = document.getElementById('todos')
                todosList.appendChild(listItem)
            }

            function addGoalToDOM(goal) {
                const listItem = document.createElement('li')
                const text = document.createTextNode(goal.name)
                listItem.appendChild(text)
                listItem.appendChild(createRemoveButton(() => {
                    myStore.dispatch(removeGoalAction(goal.id))
                }))
                listItem.style.textDecoration = goal.complete ? 'line-through' : 'none'
                listItem.addEventListener('click', ()=>myStore.dispatch(toggleTodoAction(goal.id)))
                const goalsList = document.getElementById('goals')
                goalsList.appendChild(listItem)
            }

            const addTodo = () => {
                const input = document.getElementById("todo")
                const name = input.value
                input.value = ''

                myStore.dispatch(addTodoAction({
                    id: generateId(),
                    name,
                    complete: false
                }))
            }

            const addGoal = () => {
                const input = document.getElementById("goal")
                const name = input.value
                input.value = ''

                myStore.dispatch(addGoalAction({
                    id: generateId(),
                    name
                }))
            }

            document.getElementById("addTodoButton")
            .addEventListener('click', addTodo)

            document.getElementById("addGoalButton")
            .addEventListener('click', addGoal)

        </script>
    </body>
</html>
